<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Designer</title>
    <link rel="icon" href="./favicon.ico" type="image/x-icon">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="./styles.css">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body x-data="app()">
    <div id="app" class="d-flex container-fluid flex-row vh-100 p-0">
        <!-- Modal Backdrop -->
        <div x-show="ui.dialog.show" class="modal-backdrop" :class="{ 'show': ui.dialog.show }"></div>

        <!-- Modal Dialog -->
        <div :class="`modal fade ${ui.dialog.show ? 'show' : ''}`" id="staticBackdrop" data-bs-backdrop="static"
            data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel"
            :style="`display: ${ui.dialog.show ? 'block' : 'none'}`">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-body" x-html="ui.dialog.body">
                    </div>
                    <div class="modal-footer">
                        <template x-for="(option, index) in ui.dialog.actions" :key="index">
                            <button type="button" class="btn btn-primary" data-bs-dismiss="modal" x-text="option"
                                x-on:click="ui.dialog.callback(option)"></button>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Left Column: Editors & Table -->
        <div class="col-md-6">
            <div id="code-editor" class="code-editor h-50 d-flex flex-column">
                <!-- Bootstrap Tabs -->
                <ul class="nav nav-tabs" id="editorTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="source-tab" data-bs-toggle="tab" data-bs-target="#source"
                            type="button" role="tab">
                            <i class="fas fa-code me-2"></i>Source
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="compiled-tab" data-bs-toggle="tab" data-bs-target="#compiled"
                            type="button" role="tab">
                            <i class="fas fa-cogs me-2"></i>Compiled
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content flex-grow-1">
                    <div class="tab-pane show active h-100" id="source" role="tabpanel">
                        <div id="source-editor" class="h-100"></div>
                    </div>
                    <div class="tab-pane h-100" id="compiled" role="tabpanel">
                        <div id="compiled-editor" class="h-100"></div>
                    </div>
                </div>
            </div>
            <div id="table-container" class="h-50 align-items-center justify-content-center overflow-auto">
                <div x-show="cache.data.isLoading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <table id="cache.data-table" class="table table-striped table-hover" x-show="!cache.data.isLoading">
                    <thead>
                        <tr>
                            <template x-for="value in Object.keys(cache.data.cards[0] ?? {})">
                                <th x-text="value"></th>
                            </template>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <template x-for="(card, index) in cache.data.cards" :key="index">
                            <tr x-on:click="select(card)" :class="{ 'highlight': data.selectedCard === card }">
                                <template x-for="value in Object.keys(card)">
                                    <td x-text="card[value]"></td>
                                </template>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Right Column: Preview -->
        <div id="svg-preview" class="col-md-6 vh-40 d-flex flex-column">
            <div class="svg-preview w-100 flex-grow-1 d-flex justify-content-center align-items-center">
                <div x-html="cache.code.target"></div>
            </div>
        </div>

        <button class="position-fixed top-0 end-0 btn btn-primary m-3" type="button" data-bs-toggle="offcanvas"
            data-bs-target="#menu">
            <i class="fas fa-arrow-left"></i>
        </button>
    </div>

    <!-- Offcanvas -->
    <div class="offcanvas offcanvas-end" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="menu">

        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="fileViewLabel">Menu</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body container mt-5">
            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" role="tab" data-bs-toggle="tab" href="#files"><i
                            class="fas fa-folder-open"></i>
                        Files</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" role="tab" data-bs-toggle="tab" href="#jobs"><i class="fas fa-terminal"></i>
                        Jobs</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" role="tab" data-bs-toggle="tab" href="#settings"><i class="fas fa-cog"></i>
                        Settings</a>
                </li>
            </ul>

            <!-- Todo: Separate into single views -->
            <!-- Tab panes -->
            <div class="tab-content mt-3">
                <div class="tab-pane active" id="files" role="tabpanel">
                    <div class="mb-3">
                        <label for="formFileMultiple" class="form-label">Choose Workspace Directory</label>
                        <input class="form-control" type="file" multiple webkitdirectory
                            @change="actions.loadFiles($event.target.files)">
                        <!-- TODO: Warning if too many files are uploaded: Hint that Blacklist exists! -->
                    </div>
                    <div>
                        <ul id="file-list" class="scrollable-list">
                            <template x-for="(file, index) in project.files.loadedFilteredFiles" :key="index">
                                <li x-text="file"></li>
                            </template>
                            <div x-show="project.files.loadedFilteredFiles.length === 0">No files uploaded.</div>
                        </ul>
                    </div>
                    <div class="mt-3" x-show="cache.files.fileMap.size > 0">
                        <label class="form-label"
                            x-text="`Blacklist Filters (${cache.files.fileMap.size - project.files.loadedFilteredFiles.length} files are filtered)`"></label>
                        <div class="mb-2">
                            <template x-for="(filter, index) in project.settings.files.blacklist" :key="index">
                                <div class="input-group mb-2">
                                    <input type="text" class="form-control"
                                        x-model="project.settings.files.blacklist[index]" placeholder="temporary/.*"
                                        @input="actions.updateFilteredFiles">
                                </div>
                            </template>

                            <!-- For new blacklist entries, this can be modified! -->
                            <input type="text" class="form-control"
                                x-model="project.settings.files.blacklist[project.settings.files.blacklist.length]"
                                placeholder="temporary/.*" @input="actions.updateFilteredFiles">
                        </div>
                    </div>
                </div>
                <div class="tab-pane" id="jobs" role="tabpanel">
                    <template x-for="(job, index) in project.jobs" :key="index">
                        <div>
                            <button class="btn btn-primary" type="button" data-bs-toggle="collapse"
                                x-data-bs-target="`#job-${index}`" aria-expanded="false" x-aria-controls="`#job-${index}`" x-text="job.name">
                            </button>
                            <div class="collapse" x-id="`#job-${index}`">
                                <div class="card card-body">
                                    
                                </div>
                            </div>
                        </div>
                    </template>
                    <button class="btn btn-success" x-on:click="actions.addRenderJob()">Add Render Job</button>
                </div>
                <div class="tab-pane" id="settings" role="tabpanel">
                    <div class="mb-3">
                        <label for="projectName" class="form-label">Project Name</label>
                        <input type="text" id="projectName" class="form-control" placeholder="My Cardcreator Project"
                            x-model="project.name"></input>
                        <div class="mb-3">
                            <label for="fileUrl" class="form-label">URL or file name for card data</label>
                            <input type="text" id="fileUrl" class="form-control" placeholder="my-game-cards.xlsx"
                                x-model="project.settings.datasource"></input>
                            <span>
                                <div x-show="cache.data.datatype === 'URL'">
                                    <i class="fas fa-globe"></i>
                                    Is a valid URL
                                    <i class="valid fas fa-check"></i>
                                    <div>
                                        <button @click="actions.loadRemoteData">Load Data</button>
                                    </div>
                                </div>
                                <div x-show="cache.data.datatype === 'File'">
                                    <i class="fas fa-file"></i>
                                    Is a valid file
                                    <i class="valid fas fa-check"></i>
                                </div>
                                <div x-show="cache.data.datatype === 'Error'">
                                    <i class="invalid fas fa-times"></i>
                                    This neither points to a valid file or URL!
                                </div>
                            </span>
                        </div>
                        <div class="mb-3">
                            <div x-show="cache.data.filetype === 'CSV'">
                                <label for="mainSheet" class="form-label">Expression to split CSV fields by</label>
                                <input id="csvSeparator" type="text" class="form-control" placeholder=","
                                    x-model="project.settings.csv.separator">
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Key</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Setting 1</td>
                                        <td>Value 1</td>
                                    </tr>
                                    <tr>
                                        <td>Setting 2</td>
                                        <td>Value 2</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Download Button -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-primary" @click="actions.downloadSettings"
                            data-bs-toggle="tooltip" data-bs-placement="top" title="Download Project Settings">
                            <i class="fas fa-download me-2"></i>Download Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toasts -->
    <div class="toast-container">
        <template x-for="(toast, index) in ui.toasts" :key="index">
            <div :class="`toast fade show align-items-center text-bg-${toast.severity} border-0 position-fixed bottom-0 end-0 m-3`"
                role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body" x-text="toast.body"></div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                        aria-label="Close"></button>
                </div>
            </div>
        </template>
    </div>

    <script src="./bundle.js"></script>
</body>

</html>